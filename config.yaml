# Helicopter FX Configuration
# Configuration for both engine and gun effects

# IMPORTANT: This system uses pigpio library for GPIO control
# WM8960 Audio HAT pins MUST be excluded from pigpio to prevent conflicts
# Run: sudo pigpiod -x 0x3C000C
# Or configure via systemd override (see docs/PIGPIO_SETUP.md)

# GPIO Pin Layout Strategy:
# WM8960 Audio HAT reserves: GPIO 2,3 (I2C), GPIO 18,19,20,21 (I2S/PCM)
# Three groups of adjacent pins:
# 1. INPUT SIGNALS: GPIO 5,6,12,13,16 (Physical pins 29,31,32,33,36) - Left side cluster
# 2. SERVO OUTPUTS: GPIO 7,8 (Physical pins 26,24) - Right side adjacent pair
# 3. ENGINE/GUN FX: GPIO 22,23,24,25 (Physical pins 15,16,18,22) - Right side cluster

# Engine FX Configuration
engine_fx:
  enabled: true
  
  # Engine Toggle PWM Input
  engine_toggle:
    pin: 5                     # GPIO 5 (physical pin 29) - INPUT GROUP
    threshold_us: 1500         # PWM threshold in microseconds (engine on/off)
  
  # Sound Files and Transitions
  sounds:
    starting: "~helifx/assets/engine_start.wav"    # Engine start-up sound (optional)
    running: "~helifx/assets/engine_loop.wav"      # Engine running loop sound (optional)
    stopping: "~helifx/assets/engine_stop.wav"     # Engine shut-down sound (optional)
    
    # Transition Offsets
    transitions:
      starting_offset_ms: 60000    # Offset when restarting from stopping state
      stopping_offset_ms: 25000    # Offset when stopping from starting state

# Gun FX Configuration
gun_fx:
  enabled: true
  
  # Trigger PWM Input
  trigger:
    pin: 6                     # GPIO 6 (physical pin 31) - INPUT GROUP
  
  # Nozzle Flash LED
  nozzle_flash:
    enabled: true
    pin: 22                    # GPIO 22 (physical pin 15) - ENGINE/GUN FX GROUP
  
  # Smoke Generator
  smoke:
    enabled: true
    fan_pin: 23                # GPIO 23 (physical pin 16) - ENGINE/GUN FX GROUP
    heater_pin: 24             # GPIO 24 (physical pin 18) - ENGINE/GUN FX GROUP
    heater_toggle_pin: 12      # GPIO 12 (physical pin 32) - INPUT GROUP
    heater_pwm_threshold_us: 1500  # PWM threshold for heater toggle
    fan_off_delay_ms: 2000     # Delay before turning smoke fan off after firing stops
  
  # Rates of Fire
  # Each rate defines RPM, PWM threshold, and associated sound
  # Rates should be ordered from lowest to highest threshold for optimal performance
  rates_of_fire:
    - name: "200"
      rpm: 200                 # Rounds per minute
      pwm_threshold_us: 1300   # PWM threshold in microseconds
      sound_file: "~helifx/assets/gun_200rpm.wav"  # Sound file to play (optional)
    
    - name: "550"
      rpm: 550                 # Rounds per minute
      pwm_threshold_us: 1600   # PWM threshold in microseconds
      sound_file: "~helifx/assets/gun_550rpm.wav"  # Sound file to play (optional)
  
  # Turret Control Servos
  turret_control:
    pitch:
      enabled: true            # Enable pitch axis servo control
      pwm_pin: 13              # GPIO 13 (physical pin 33) - INPUT GROUP
      output_pin: 7            # GPIO 7 (physical pin 26) - SERVO OUTPUT GROUP
      input_min_us: 1000       # Minimum input PWM pulse width (µs)
      input_max_us: 2000       # Maximum input PWM pulse width (µs)
      output_min_us: 1000      # Minimum output PWM pulse width (µs)
      output_max_us: 2000      # Maximum output PWM pulse width (µs)
      max_speed_us_per_sec: 500.0      # Maximum speed (µs/second, 0=unlimited)
      max_accel_us_per_sec2: 200.0    # Maximum acceleration (µs/second², 0=unlimited)
      update_rate_hz: 50       # Servo update rate (Hz)
    
    yaw:
      enabled: true            # Enable yaw axis servo control
      pwm_pin: 16              # GPIO 16 (physical pin 36) - INPUT GROUP
      output_pin: 8            # GPIO 8 (physical pin 24) - SERVO OUTPUT GROUP
      input_min_us: 1000       # Minimum input PWM pulse width (µs)
      input_max_us: 2000       # Maximum input PWM pulse width (µs)
      output_min_us: 1000      # Minimum output PWM pulse width (µs)
      output_max_us: 2000      # Maximum output PWM pulse width (µs)
      max_speed_us_per_sec: 500.0      # Maximum speed (µs/second, 0=unlimited)
      max_accel_us_per_sec2: 200.0    # Maximum acceleration (µs/second², 0=unlimited)
      update_rate_hz: 50       # Servo update rate (Hz)
  
  # Hysteresis Settings (internal, not typically changed)
  # hysteresis_us: 50          # Deadzone for rate switching to prevent oscillation

# Hardware Notes:
# - WM8960 Audio HAT reserves: GPIO 2,3 (I2C), GPIO 18,19,20,21 (I2S/PCM)
# 
# GPIO Pin Groups (all pins within each group are physically adjacent):
#
# GROUP 1 - INPUT SIGNALS (Physical pins 29,31,32,33,36 - Left side):
#   GPIO 5  (pin 29) - Engine toggle PWM input
#   GPIO 6  (pin 31) - Gun trigger PWM input
#   GPIO 12 (pin 32) - Smoke heater toggle PWM input
#   GPIO 13 (pin 33) - Pitch servo PWM input
#   GPIO 16 (pin 36) - Yaw servo PWM input
#
# GROUP 2 - SERVO OUTPUTS (Physical pins 24,26 - Right side adjacent):
#   GPIO 8  (pin 24) - Yaw servo PWM output
#   GPIO 7  (pin 26) - Pitch servo PWM output
#
# GROUP 3 - ENGINE/GUN FX (Physical pins 15,16,18,22 - Right side):
#   GPIO 22 (pin 15) - Nozzle flash LED
#   GPIO 23 (pin 16) - Smoke fan control
#   GPIO 24 (pin 18) - Smoke heater control
#   GPIO 25 (pin 22) - [Available for future use]
#
# - Ensure PWM inputs use RC signal (typically 50Hz, 1000-2000µs pulse width)
# - LED blinks at firing rate (synchronized with rounds per minute)
# - Sounds loop continuously while in their respective states
# - Smoke fan continues running for fan_off_delay_ms after firing stops
# - Smoke heater can be controlled independently via PWM toggle input

# JetiEX Telemetry Configuration
jetiex:
  enabled: false               # Enable JetiEX telemetry
  remote_config: true          # Enable remote configuration via transmitter
  serial_port: "/dev/ttyAMA0"  # Serial port for telemetry (UART)
  baud_rate: 115200            # Baud rate (9600, 19200, 38400, 57600, 115200, 230400)
  manufacturer_id: 0xA409      # Manufacturer ID (16-bit hex)
  device_id: 0x0001            # Device ID (16-bit hex)
  update_rate_hz: 10           # Telemetry update rate (5-100 Hz)
